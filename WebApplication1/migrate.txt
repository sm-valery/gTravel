CREATE TABLE [dbo].[RiskSeria] (
    [RiskSeriaId]    UNIQUEIDENTIFIER DEFAULT (newid()) NOT NULL,
    [RiskId]         UNIQUEIDENTIFIER NULL,
    [SeriaId]        UNIQUEIDENTIFIER NULL,
    [isMandatory]    BIT              DEFAULT ((0)) NOT NULL,
    [sort]           INT              DEFAULT ((0)) NULL,
    [InsSumDefauld]  NUMERIC (18)     DEFAULT ((0)) NULL,
    [TypeTarif]      INT              DEFAULT ((0)) NULL,
    [hasFranchise]   INT              DEFAULT ((0)) NULL,
    [InsSumReadOnly] BIT              DEFAULT ((1)) NULL,
    PRIMARY KEY CLUSTERED ([RiskSeriaId] ASC), 
+    CONSTRAINT [FK_RiskSeria_ToSeria] FOREIGN KEY ([SeriaId]) REFERENCES [seria]([SeriaId]), 
+    CONSTRAINT [FK_RiskSeria_ToRisk] FOREIGN KEY ([RiskId]) REFERENCES [Risk]([RiskId])
);

CREATE TABLE [dbo].[seria] (
    [SeriaId]            UNIQUEIDENTIFIER NOT NULL,
    [Code]               NCHAR (10)       NULL,
    [Name]               NCHAR (512)      NULL,
    [IsMulti]            INT              DEFAULT ((1)) NULL,
    [formname]           NVARCHAR (50)    NULL,
    [DefaultCurrencyId]  UNIQUEIDENTIFIER NULL,
    [AutoNumber]         INT              DEFAULT ((0)) NULL,
    [numberformat]       VARCHAR (50)     NULL,
    [DefaultTerritoryId] UNIQUEIDENTIFIER NULL,
    [PrintFunction]      VARCHAR (128)    NULL,
   + [AssuredMax] INT NULL DEFAULT 1, 
    PRIMARY KEY CLUSTERED ([SeriaId] ASC),
    CONSTRAINT [FK_seria_ToTable] FOREIGN KEY ([DefaultCurrencyId]) REFERENCES [dbo].[Currency] ([CurrencyId])
);

CREATE TABLE [dbo].[Subject] (
    [SubjectId]        UNIQUEIDENTIFIER DEFAULT (newid()) NOT NULL,
    [Name1]            NCHAR (255)      NULL,
    [Type]             NCHAR (10)       NULL,
    [ContractId]       UNIQUEIDENTIFIER NULL,
    [DateOfBirth]      DATE             NULL,
    +[Pasport]          NCHAR (50)       NULL,
    [Address]          NCHAR (255)      NULL,
    [Phone]            NCHAR (255)      NULL,
    [Gender]           NCHAR (1)        DEFAULT ('N') NULL,
    [PlaceOfBirth]     NCHAR (256)      NULL,
    [PasportValidDate] DATE             NULL,
    [num]              INT              DEFAULT ((0)) NULL,
    [Name2]            NCHAR (255)      NULL,
    PRIMARY KEY CLUSTERED ([SubjectId] ASC),
    CONSTRAINT [FK_Subject_ToContract] FOREIGN KEY ([ContractId]) REFERENCES [dbo].[Contract] ([ContractId])
);


GO
CREATE NONCLUSTERED INDEX [IX_Subject_ContractId]
    ON [dbo].[Subject]([ContractId] ASC);


23.07.2015
1. CREATE TABLE [dbo].[Factors] (
    [IdFactor]          UNIQUEIDENTIFIER DEFAULT (newid()) NOT NULL,
    [FactorType]        NCHAR (10)       NULL,
    [Factor]            NUMERIC (10, 4)  NULL,
    [ValueFrom]         NUMERIC (18)     NULL,
    [ValueTo]           NUMERIC (18)     NULL,
    [SeriaId]           UNIQUEIDENTIFIER NULL,
    [RiskId]            UNIQUEIDENTIFIER NULL,
    [Name]              NVARCHAR (50)    NULL,
    [SingleItemInGroup] BIT              DEFAULT ((1)) NOT NULL,
    [Position]          INT              DEFAULT ((0)) NULL,
    [auto]              BIT              DEFAULT ((0)) NOT NULL,
    [AgentSeriaId]      UNIQUEIDENTIFIER NULL,
    [TerritoryId]       UNIQUEIDENTIFIER NULL,
    +[RiskProgramId] UNIQUEIDENTIFIER NULL, 
	+[FactorAccess]      INT              DEFAULT ((0)) NULL,
    PRIMARY KEY CLUSTERED ([IdFactor] ASC),
    CONSTRAINT [FK_Factors_ToTerritory] FOREIGN KEY ([TerritoryId]) REFERENCES [dbo].[Territory] ([TerritoryId]),
    CONSTRAINT [FK_Factors_ToAgentSeria] FOREIGN KEY ([AgentSeriaId]) REFERENCES [dbo].[AgentSeria] ([AgentSeriaId]),
    CONSTRAINT [FK_Factors_ToRisk] FOREIGN KEY ([RiskId]) REFERENCES [dbo].[Risk] ([RiskId])
);


GO
CREATE NONCLUSTERED INDEX [IX_Factors_AgentSeriaId]
    ON [dbo].[Factors]([AgentSeriaId] ASC);


GO

CREATE INDEX [IX_Factors_RiskProgramId] ON [dbo].[Factors] ([RiskProgramId])
---------------
2.CREATE VIEW [dbo].[v_contract_factors]
	AS 
	SELECT cf.* , 
	f.Name Factorname,
	f.FactorType, fa.RiskProgramId,
ISNULL(fa.FactorAccess,0) FactorAccess
 FROM ContractFactor cf
	join Factors f on f.IdFactor = cf.IdFactor
	left join Factors fa on fa.AgentSeriaId=f.AgentSeriaId and fa.FactorType = f.FactorType and fa.FactorAccess=1
============================================

--20.07.2015 done
CREATE TABLE [dbo].[RiskProgram] (
    [RiskProgramId] UNIQUEIDENTIFIER NOT NULL,
    [ProgramCode]   NCHAR (20)       NULL,
    [RiskSeriaId]   UNIQUEIDENTIFIER NULL,
    [Name]          VARCHAR (50)     NULL,
    [DefaultInsSum] MONEY            NULL,
    [InsSumInList]  BIT              DEFAULT ((0)) NOT NULL,
   + [Num] INT NULL DEFAULT 0, 
    PRIMARY KEY CLUSTERED ([RiskProgramId] ASC)
);

CREATE TABLE [dbo].[RiskSeria] (
    [RiskSeriaId]   UNIQUEIDENTIFIER DEFAULT (newid()) NOT NULL,
    [RiskId]        UNIQUEIDENTIFIER NULL,
    [SeriaId]       UNIQUEIDENTIFIER NULL,
    [isMandatory]   BIT              DEFAULT ((0)) NOT NULL,
    [sort]          INT              DEFAULT ((0)) NULL,
    [InsSumDefauld] NUMERIC (18)     DEFAULT ((0)) NULL,
    [TypeTarif]     INT              DEFAULT ((0)) NULL,
    [hasFranchise]  INT              DEFAULT ((0)) NULL,
+    [InsSumReadOnly] BIT NULL DEFAULT 1, 
    PRIMARY KEY CLUSTERED ([RiskSeriaId] ASC)
);




--16.07.2015 done
--create view vAgents
CREATE TABLE [dbo].[TarifPlan] (
    [TarifPlanId] UNIQUEIDENTIFIER DEFAULT (newid()) NOT NULL,
    [Code]        NCHAR (10)       NULL,
    [Name]        NVARCHAR (50)    NULL,
  +  [SeriaId]     UNIQUEIDENTIFIER NULL,
    PRIMARY KEY CLUSTERED ([TarifPlanId] ASC), 
  +  CONSTRAINT [FK_TarifPlan_ToTable] FOREIGN KEY ([SeriaId]) REFERENCES [seria]([seriaid])
);

CREATE TABLE [dbo].[Territory] (
    [TerritoryId]    UNIQUEIDENTIFIER DEFAULT (newid()) NOT NULL,
    [Name]           VARCHAR (512)    NULL,
    [TerritoryGrpId] UNIQUEIDENTIFIER NULL,
    [ParentId]       UNIQUEIDENTIFIER NULL,
    +[RecomInsSum]    DECIMAL (18)     NULL,
    PRIMARY KEY CLUSTERED ([TerritoryId] ASC)
);


CREATE TABLE [dbo].[AgentSeria] (
    [AgentSeriaId]   UNIQUEIDENTIFIER DEFAULT (newid()) NOT NULL,
    [AgentId]        UNIQUEIDENTIFIER NULL,
    [SeriaId]        UNIQUEIDENTIFIER NULL,
    [TerritoryGrpId] UNIQUEIDENTIFIER NULL,
    [AgentFee]       NUMERIC (18)     NULL,
    +[HidePremium] BIT NULL DEFAULT 0 NOT NULL, 
    PRIMARY KEY CLUSTERED ([AgentSeriaId] ASC),
    CONSTRAINT [FK_AgentSeria_ToAgent] FOREIGN KEY ([AgentId]) REFERENCES [dbo].[Agent] ([AgentId]),
    CONSTRAINT [FK_AgentSeria_ToTerritoryGrp] FOREIGN KEY ([TerritoryGrpId]) REFERENCES [dbo].[TerritoryGrp] ([TerritoryGrpId]),
    CONSTRAINT [FK_AgentSeria_Toseria] FOREIGN KEY ([SeriaId]) REFERENCES [dbo].[seria] ([SeriaId])
);
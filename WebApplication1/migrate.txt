CREATE VIEW [dbo].[v_contract_agent]
	AS 
	select
c1.*,
InsPremRur * [Percent]/100 sum_share
from 
(
select c.*,
s.Code SeriaCode,
ca.AgentId, ca.[Percent], 
(select sum(InsPremRur) from ContractRisk cr where cr.ContractId = c.ContractId) InsPremRur
from contract c
join ContractStatus cs on cs.ContractStatusId = c.ContractStatusId
join Status st on st.StatusId = cs.StatusId
join seria s on s.SeriaId = c.seriaid
left join ContractAgent ca on ca.ContractId = c.ContractId
where st.Code = 'confirmed'
) c1

CREATE TABLE [dbo].[AgentUser] (
    [AgentUserId]  UNIQUEIDENTIFIER DEFAULT (newid()) NOT NULL,
    [AgentId]      UNIQUEIDENTIFIER NULL,
    [UserId]       NVARCHAR (128)   NULL,
    [IsGlobalUser] INT              DEFAULT ((1)) NULL,
    PRIMARY KEY CLUSTERED ([AgentUserId] ASC),
    CONSTRAINT [FK_AgentUser_ToTable_1] FOREIGN KEY ([UserId]) REFERENCES [dbo].[AspNetUsers] ([Id]), 
    +CONSTRAINT [FK_AgentUser_ToAgent] FOREIGN KEY ([AgentID]) REFERENCES [Agent]([AgentId])
);


INSERT INTO [dbo].[AddRefs] ([AddRefsId], [Code], [Value], [OrderNum]) VALUES (N'9c791649-711a-480f-9b13-0bebcb7df102', N'subjtype                      ', N'Физ-лицо', CAST(1 AS Decimal(18, 0)))
INSERT INTO [dbo].[AddRefs] ([AddRefsId], [Code], [Value], [OrderNum]) VALUES (N'a9b967e7-25bb-4b10-bade-f4ee3b6a57c9', N'subjtype                      ', N'Юр-лицо', CAST(0 AS Decimal(18, 0)))
INSERT INTO [dbo].[AddRefs] ([AddRefsId], [Code], [Value], [OrderNum]) VALUES (N'2f1cc5dd-98fb-46fd-bfd6-2a7f263e5c56', N'subjtype                      ', N'IC', NULL)

CREATE TABLE [dbo].[AddRefs] (
  =  [AddRefsId] UNIQUEIDENTIFIER NOT NULL DEFAULT newid(),
    [Code]      NCHAR (30)       NULL,
    [Value]     NCHAR (100)      NULL,
    [OrderNum]  DECIMAL (18)     NULL,
    PRIMARY KEY CLUSTERED ([AddRefsId] ASC)
);

26.08.2015
CREATE TABLE [dbo].[Agent] (
    [AgentId]           UNIQUEIDENTIFIER DEFAULT (newid()) NOT NULL,
    [Name]              NVARCHAR (50)    NULL,
    [AgentContractNum]  NVARCHAR (50)    NULL,
    [AgentContractDate] DATE             NULL,
    [ParentId]          UNIQUEIDENTIFIER NULL,
    +[AgentType]         UNIQUEIDENTIFIER NULL,
    PRIMARY KEY CLUSTERED ([AgentId] ASC),
    CONSTRAINT [FK_Agent_ToAgent] FOREIGN KEY ([ParentId]) REFERENCES [dbo].[Agent] ([AgentId]), 
    +CONSTRAINT [FK_Agent_ToAgentType] FOREIGN KEY ([AgentType]) REFERENCES [AddRefs](AddRefsId)
);



========= done
CREATE TABLE [dbo].[Contract] (
    [ContractId]           UNIQUEIDENTIFIER NOT NULL,
    [currencyid]           UNIQUEIDENTIFIER NOT NULL,
    [contractnumber]       DECIMAL (18)     NULL,
    [seriaid]              UNIQUEIDENTIFIER NOT NULL,
    [date_begin]           DATE             NULL,
    [date_end]             DATE             NULL,
    [date_diff]            INT              NULL,
    [Holder_SubjectId]     UNIQUEIDENTIFIER NULL,
    [ContractStatusId]     UNIQUEIDENTIFIER NULL,
    [period_multi_type]    NCHAR (1)        NULL,
    [UserId]               NVARCHAR (128)   NULL,
    =[date_out]             DATETIME             DEFAULT (getdate()) NULL,
    [contractnumberformat] VARCHAR (50)     NULL,
    [tripduration]         INT              DEFAULT ((0)) NULL,
    PRIMARY KEY CLUSTERED ([ContractId] ASC),
    CONSTRAINT [FK_Contract_AspNetUsers] FOREIGN KEY ([UserId]) REFERENCES [dbo].[AspNetUsers] ([Id]),
    CONSTRAINT [FK_Contract_ToSubject] FOREIGN KEY ([Holder_SubjectId]) REFERENCES [dbo].[Subject] ([SubjectId]),
    CONSTRAINT [FK_Contract_ToTable] FOREIGN KEY ([currencyid]) REFERENCES [dbo].[Currency] ([CurrencyId]),
    CONSTRAINT [FK_Contract_ToContractStatus] FOREIGN KEY ([ContractStatusId]) REFERENCES [dbo].[ContractStatus] ([ContractStatusId]),
    CONSTRAINT [FK_Contract_ToTable_1] FOREIGN KEY ([seriaid]) REFERENCES [dbo].[seria] ([SeriaId])
);


CREATE TABLE [dbo].[SeriaCurrency] (
    [SeriaCurrencyId] UNIQUEIDENTIFIER NOT NULL DEFAULT NewId(),
    [SeriaId]         UNIQUEIDENTIFIER NULL,
    [CurrencyId]      UNIQUEIDENTIFIER NULL,
    PRIMARY KEY CLUSTERED ([SeriaCurrencyId] ASC)
);

GO
CREATE NONCLUSTERED INDEX [IX_SeriaCurrency_SeriaId]
    ON [dbo].[SeriaCurrency]([SeriaId] ASC);



CREATE TABLE [dbo].[DocRel] (
    [DocRelId] UNIQUEIDENTIFIER NOT NULL,
    [DocId]    UNIQUEIDENTIFIER NOT NULL,
    [ParentId] UNIQUEIDENTIFIER NOT NULL,
    [RelType]  NCHAR (10)       NOT NULL,
    PRIMARY KEY CLUSTERED ([DocRelId] ASC)
);


GO
CREATE NONCLUSTERED INDEX [IX_DocRel_DocId]
    ON [dbo].[DocRel]([DocId] ASC);


GO
CREATE NONCLUSTERED INDEX [IX_DocRel_ParentId]
    ON [dbo].[DocRel]([ParentId] ASC);

================
CREATE TABLE [dbo].[ContractCondition] (
    [ContractCondId] UNIQUEIDENTIFIER DEFAULT (newid()) NOT NULL,
    [ConditionId]    UNIQUEIDENTIFIER NULL,
    [Contractid]     UNIQUEIDENTIFIER NULL,
    [Val_c]          NVARCHAR (255)   NULL,
    [Val_n]          DECIMAL (18, 4)  NULL,
    [Val_l]          BIT              NULL,
    [Val_d]          DATE             NULL,
    [num]            INT              NULL,
    [Val_id]         UNIQUEIDENTIFIER NULL,
    [link_text]      NVARCHAR (255)   NULL,
    PRIMARY KEY CLUSTERED ([ContractCondId] ASC),
    CONSTRAINT [FK_Table_ToCondition] FOREIGN KEY ([ConditionId]) REFERENCES [dbo].[Condition] ([ConditionId]),
    CONSTRAINT [FK_Table_ToContract] FOREIGN KEY ([Contractid]) REFERENCES [dbo].[Contract] ([ContractId])
);

==============

30.07.2015 done
CREATE VIEW [dbo].[v_agentseria]
	AS SELECT ass.AgentId, s.*, au.UserId FROM AgentSeria ass
	join seria s on s.SeriaId = ass.SeriaId
	join AgentUser au on au.AgentId = ass.AgentId

+CREATE TABLE [dbo].[RiskSeria] (
    [RiskSeriaId]    UNIQUEIDENTIFIER DEFAULT (newid()) NOT NULL,
    [RiskId]         UNIQUEIDENTIFIER NULL,
    [SeriaId]        UNIQUEIDENTIFIER NULL,
    [isMandatory]    BIT              DEFAULT ((0)) NOT NULL,
    [sort]           INT              DEFAULT ((0)) NULL,
    [InsSumDefauld]  NUMERIC (18)     DEFAULT ((0)) NULL,
    [TypeTarif]      INT              DEFAULT ((0)) NULL,
    [hasFranchise]   INT              DEFAULT ((0)) NULL,
    [InsSumReadOnly] BIT              DEFAULT ((1)) NULL,
    PRIMARY KEY CLUSTERED ([RiskSeriaId] ASC), 
+    CONSTRAINT [FK_RiskSeria_ToSeria] FOREIGN KEY ([SeriaId]) REFERENCES [seria]([SeriaId]), 
+    CONSTRAINT [FK_RiskSeria_ToRisk] FOREIGN KEY ([RiskId]) REFERENCES [Risk]([RiskId])
);

+CREATE TABLE [dbo].[seria] (
    [SeriaId]            UNIQUEIDENTIFIER NOT NULL,
    [Code]               NCHAR (10)       NULL,
    [Name]               NCHAR (512)      NULL,
    [IsMulti]            INT              DEFAULT ((1)) NULL,
    [formname]           NVARCHAR (50)    NULL,
    [DefaultCurrencyId]  UNIQUEIDENTIFIER NULL,
    [AutoNumber]         INT              DEFAULT ((0)) NULL,
    [numberformat]       VARCHAR (50)     NULL,
    [DefaultTerritoryId] UNIQUEIDENTIFIER NULL,
    [PrintFunction]      VARCHAR (128)    NULL,
   + [AssuredMax] INT NULL , 
    PRIMARY KEY CLUSTERED ([SeriaId] ASC),
    CONSTRAINT [FK_seria_ToTable] FOREIGN KEY ([DefaultCurrencyId]) REFERENCES [dbo].[Currency] ([CurrencyId])
);

CREATE TABLE [dbo].[Subject] (
    [SubjectId]        UNIQUEIDENTIFIER DEFAULT (newid()) NOT NULL,
    [Name1]            NCHAR (255)      NULL,
    [Type]             NCHAR (10)       NULL,
    [ContractId]       UNIQUEIDENTIFIER NULL,
    [DateOfBirth]      DATE             NULL,
    +[Pasport]          NCHAR (50)       NULL,
    [Address]          NCHAR (255)      NULL,
    [Phone]            NCHAR (255)      NULL,
    [Gender]           NCHAR (1)        DEFAULT ('N') NULL,
    [PlaceOfBirth]     NCHAR (256)      NULL,
    [PasportValidDate] DATE             NULL,
    [num]              INT              DEFAULT ((0)) NULL,
    [Name2]            NCHAR (255)      NULL,
    PRIMARY KEY CLUSTERED ([SubjectId] ASC),
    CONSTRAINT [FK_Subject_ToContract] FOREIGN KEY ([ContractId]) REFERENCES [dbo].[Contract] ([ContractId])
);


GO
CREATE NONCLUSTERED INDEX [IX_Subject_ContractId]
    ON [dbo].[Subject]([ContractId] ASC);


23.07.2015
+1. CREATE TABLE [dbo].[Factors] (
    [IdFactor]          UNIQUEIDENTIFIER DEFAULT (newid()) NOT NULL,
    [FactorType]        NCHAR (10)       NULL,
    [Factor]            NUMERIC (10, 4)  NULL,
    [ValueFrom]         NUMERIC (18)     NULL,
    [ValueTo]           NUMERIC (18)     NULL,
    [SeriaId]           UNIQUEIDENTIFIER NULL,
    [RiskId]            UNIQUEIDENTIFIER NULL,
    [Name]              NVARCHAR (50)    NULL,
    [SingleItemInGroup] BIT              DEFAULT ((1)) NOT NULL,
    [Position]          INT              DEFAULT ((0)) NULL,
    [auto]              BIT              DEFAULT ((0)) NOT NULL,
    [AgentSeriaId]      UNIQUEIDENTIFIER NULL,
    [TerritoryId]       UNIQUEIDENTIFIER NULL,
    +[RiskProgramId] UNIQUEIDENTIFIER NULL, 
	+[FactorAccess]      INT              DEFAULT ((0)) NULL,
    PRIMARY KEY CLUSTERED ([IdFactor] ASC),
    CONSTRAINT [FK_Factors_ToTerritory] FOREIGN KEY ([TerritoryId]) REFERENCES [dbo].[Territory] ([TerritoryId]),
    CONSTRAINT [FK_Factors_ToAgentSeria] FOREIGN KEY ([AgentSeriaId]) REFERENCES [dbo].[AgentSeria] ([AgentSeriaId]),
    CONSTRAINT [FK_Factors_ToRisk] FOREIGN KEY ([RiskId]) REFERENCES [dbo].[Risk] ([RiskId])
);


GO
CREATE NONCLUSTERED INDEX [IX_Factors_AgentSeriaId]
    ON [dbo].[Factors]([AgentSeriaId] ASC);


GO

CREATE INDEX [IX_Factors_RiskProgramId] ON [dbo].[Factors] ([RiskProgramId])
---------------
+2.CREATE VIEW [dbo].[v_contract_factors]
	AS 
	SELECT cf.* , 
	f.Name Factorname,
	f.FactorType, fa.RiskProgramId,
ISNULL(fa.FactorAccess,0) FactorAccess
 FROM ContractFactor cf
	join Factors f on f.IdFactor = cf.IdFactor
	left join Factors fa on fa.AgentSeriaId=f.AgentSeriaId and fa.FactorType = f.FactorType and fa.FactorAccess=1
============================================

--20.07.2015 done
CREATE TABLE [dbo].[RiskProgram] (
    [RiskProgramId] UNIQUEIDENTIFIER NOT NULL,
    [ProgramCode]   NCHAR (20)       NULL,
    [RiskSeriaId]   UNIQUEIDENTIFIER NULL,
    [Name]          VARCHAR (50)     NULL,
    [DefaultInsSum] MONEY            NULL,
    [InsSumInList]  BIT              DEFAULT ((0)) NOT NULL,
   + [Num] INT NULL DEFAULT 0, 
    PRIMARY KEY CLUSTERED ([RiskProgramId] ASC)
);

CREATE TABLE [dbo].[RiskSeria] (
    [RiskSeriaId]   UNIQUEIDENTIFIER DEFAULT (newid()) NOT NULL,
    [RiskId]        UNIQUEIDENTIFIER NULL,
    [SeriaId]       UNIQUEIDENTIFIER NULL,
    [isMandatory]   BIT              DEFAULT ((0)) NOT NULL,
    [sort]          INT              DEFAULT ((0)) NULL,
    [InsSumDefauld] NUMERIC (18)     DEFAULT ((0)) NULL,
    [TypeTarif]     INT              DEFAULT ((0)) NULL,
    [hasFranchise]  INT              DEFAULT ((0)) NULL,
+    [InsSumReadOnly] BIT NULL DEFAULT 1, 
    PRIMARY KEY CLUSTERED ([RiskSeriaId] ASC)
);




--16.07.2015 done
--create view vAgents
CREATE TABLE [dbo].[TarifPlan] (
    [TarifPlanId] UNIQUEIDENTIFIER DEFAULT (newid()) NOT NULL,
    [Code]        NCHAR (10)       NULL,
    [Name]        NVARCHAR (50)    NULL,
  +  [SeriaId]     UNIQUEIDENTIFIER NULL,
    PRIMARY KEY CLUSTERED ([TarifPlanId] ASC), 
  +  CONSTRAINT [FK_TarifPlan_ToTable] FOREIGN KEY ([SeriaId]) REFERENCES [seria]([seriaid])
);

CREATE TABLE [dbo].[Territory] (
    [TerritoryId]    UNIQUEIDENTIFIER DEFAULT (newid()) NOT NULL,
    [Name]           VARCHAR (512)    NULL,
    [TerritoryGrpId] UNIQUEIDENTIFIER NULL,
    [ParentId]       UNIQUEIDENTIFIER NULL,
    +[RecomInsSum]    DECIMAL (18)     NULL,
    PRIMARY KEY CLUSTERED ([TerritoryId] ASC)
);


CREATE TABLE [dbo].[AgentSeria] (
    [AgentSeriaId]   UNIQUEIDENTIFIER DEFAULT (newid()) NOT NULL,
    [AgentId]        UNIQUEIDENTIFIER NULL,
    [SeriaId]        UNIQUEIDENTIFIER NULL,
    [TerritoryGrpId] UNIQUEIDENTIFIER NULL,
    [AgentFee]       NUMERIC (18)     NULL,
    +[HidePremium] BIT NULL DEFAULT 0 NOT NULL, 
    PRIMARY KEY CLUSTERED ([AgentSeriaId] ASC),
    CONSTRAINT [FK_AgentSeria_ToAgent] FOREIGN KEY ([AgentId]) REFERENCES [dbo].[Agent] ([AgentId]),
    CONSTRAINT [FK_AgentSeria_ToTerritoryGrp] FOREIGN KEY ([TerritoryGrpId]) REFERENCES [dbo].[TerritoryGrp] ([TerritoryGrpId]),
    CONSTRAINT [FK_AgentSeria_Toseria] FOREIGN KEY ([SeriaId]) REFERENCES [dbo].[seria] ([SeriaId])
);